# System Architecture: Fidget Fun Native App Migration

**Document Version**: 1.0.0
**Created**: 2025-10-22
**FORGE Cycle**: app-store-migration-native-ios-android-apps
**Phase**: Focus

---

## High-Level System Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                     DEPLOYMENT TARGETS                       │
├──────────────┬──────────────┬──────────────┬────────────────┤
│   iOS App    │ Android App  │   Web PWA    │   Local Dev    │
│  (App Store) │ (Play Store) │ (GitHub Pgs) │  (localhost)   │
└──────┬───────┴──────┬───────┴──────┬───────┴────────┬───────┘
       │              │              │                │
       └──────────────┴──────────────┴────────────────┘
                      │
       ┌──────────────▼───────────────────┐
       │   CAPACITOR BRIDGE LAYER         │
       │  (Runtime Environment Detection) │
       └──────────────┬───────────────────┘
                      │
       ┌──────────────▼───────────────────────────────┐
       │         PLATFORM ABSTRACTION LAYER           │
       │  ┌──────────┬──────────┬──────────┐          │
       │  │ Haptics  │  Storage │StatusBar │          │
       │  │ Adapter  │  Adapter │ Adapter  │          │
       │  └────┬─────┴────┬─────┴────┬─────┘          │
       │       │          │          │                │
       │  ┌────▼──────────▼──────────▼─────┐          │
       │  │   Native Plugins (Capacitor)   │          │
       │  │  Browser APIs (Web Fallback)   │          │
       │  └────────────────────────────────┘          │
       └──────────────┬───────────────────────────────┘
                      │
       ┌──────────────▼───────────────────────────────┐
       │         CORE APPLICATION LAYER               │
       │  ┌──────────────────────────────────────┐    │
       │  │  Single Page Application (index.html)│    │
       │  │  ┌────────────────────────────────┐  │    │
       │  │  │    5 Screen Components         │  │    │
       │  │  │  • Buttons (Particles/Audio)   │  │    │
       │  │  │  • Spinner (Physics Engine)    │  │    │
       │  │  │  • Sliders (RGB Mixer)         │  │    │
       │  │  │  • Pop It (State Management)   │  │    │
       │  │  │  • Drawing (Canvas API)        │  │    │
       │  │  └────────────────────────────────┘  │    │
       │  │                                       │    │
       │  │  ┌────────────────────────────────┐  │    │
       │  │  │    Core Services               │  │    │
       │  │  │  • Tab Navigation              │  │    │
       │  │  │  • Event Handlers              │  │    │
       │  │  │  • Animation Engine            │  │    │
       │  │  │  • Audio Synthesizer           │  │    │
       │  │  └────────────────────────────────┘  │    │
       │  └──────────────────────────────────────┘    │
       └──────────────────────────────────────────────┘
                      │
       ┌──────────────▼───────────────────────────────┐
       │         ASSET MANAGEMENT LAYER               │
       │  • Static Assets (bundled in www/)           │
       │  • Lucide Icons (bundled locally)            │
       │  • CSS Animations & Styles                   │
       │  • Service Worker (conditional)              │
       └──────────────────────────────────────────────┘
```

## Project File Structure

```
silly-apps/
├── www/                           # Web root (Capacitor serves from here)
│   ├── index.html                # Main HTML (updated paths)
│   ├── app.js                    # Application logic (with adapters)
│   ├── styles.css                # All styles
│   ├── sw.js                     # Service Worker (conditional registration)
│   ├── manifest.json             # Web manifest (web-only)
│   ├── assets/
│   │   ├── icons/               # App icons
│   │   │   ├── icon-192.png
│   │   │   ├── icon-512.png
│   │   │   └── icon-1024.png    # iOS App Store icon
│   │   └── lucide/              # Bundled Lucide icons (offline support)
│   │       └── lucide.min.js    # Downloaded from CDN, bundled locally
│   └── lib/                     # New: Abstraction libraries
│       ├── capacitor-bridge.js  # Environment detection
│       └── platform-adapters.js # Native API wrappers
│
├── ios/                          # Generated by Capacitor
│   └── App/
│       ├── App.xcodeproj
│       ├── App.xcworkspace       # Open this in Xcode
│       ├── App/
│       │   ├── Info.plist        # iOS permissions config
│       │   ├── Assets.xcassets/  # iOS app icons
│       │   │   └── AppIcon.appiconset/
│       │   └── config.xml
│       └── Podfile               # CocoaPods dependencies
│
├── android/                      # Generated by Capacitor
│   └── app/
│       ├── src/main/
│       │   ├── AndroidManifest.xml  # Android permissions
│       │   ├── res/
│       │   │   ├── mipmap-*/       # Adaptive icons
│       │   │   ├── values/
│       │   │   │   ├── strings.xml
│       │   │   │   └── colors.xml
│       │   │   └── drawable/       # Splash screen assets
│       │   └── assets/
│       └── build.gradle           # Android build config
│
├── capacitor.config.json         # Capacitor configuration
├── package.json                  # Node dependencies
├── package-lock.json
├── .gitignore                    # Ignore node_modules, ios/App/Pods
│
├── docs/                         # FORGE documentation
│   ├── prd/
│   ├── testing/
│   └── architecture/             # This document
│
├── scripts/                      # Build automation
│   ├── build-ios.sh             # iOS build script
│   ├── build-android.sh         # Android build script
│   └── sync-www.sh              # Sync web assets to native
│
└── README.md                     # Updated instructions
```

## Component Architecture

### 1. Capacitor Bridge Layer

**File**: `www/lib/capacitor-bridge.js`
**Responsibility**: Detect runtime environment and provide platform info

```javascript
const CapacitorBridge = {
  isNative: () => {
    return typeof window.Capacitor !== 'undefined';
  },

  isIOS: () => {
    return CapacitorBridge.isNative() &&
           window.Capacitor.getPlatform() === 'ios';
  },

  isAndroid: () => {
    return CapacitorBridge.isNative() &&
           window.Capacitor.getPlatform() === 'android';
  },

  isWeb: () => {
    return !CapacitorBridge.isNative();
  },

  getPlatform: () => {
    if (CapacitorBridge.isIOS()) return 'ios';
    if (CapacitorBridge.isAndroid()) return 'android';
    return 'web';
  }
};
```

### 2. Platform Adapters

**File**: `www/lib/platform-adapters.js`
**Responsibility**: Abstract platform-specific APIs with unified interface

#### Haptics Adapter

```javascript
const HapticsAdapter = {
  async light() {
    if (CapacitorBridge.isNative()) {
      const { Haptics, ImpactStyle } = await import('@capacitor/haptics');
      await Haptics.impact({ style: ImpactStyle.Light });
    } else if ('vibrate' in navigator) {
      navigator.vibrate(10);
    }
  },

  async medium() {
    if (CapacitorBridge.isNative()) {
      const { Haptics, ImpactStyle } = await import('@capacitor/haptics');
      await Haptics.impact({ style: ImpactStyle.Medium });
    } else if ('vibrate' in navigator) {
      navigator.vibrate(20);
    }
  },

  async heavy() {
    if (CapacitorBridge.isNative()) {
      const { Haptics, ImpactStyle } = await import('@capacitor/haptics');
      await Haptics.impact({ style: ImpactStyle.Heavy });
    } else if ('vibrate' in navigator) {
      navigator.vibrate(30);
    }
  },

  async success() {
    if (CapacitorBridge.isNative()) {
      const { Haptics, NotificationType } = await import('@capacitor/haptics');
      await Haptics.notification({ type: NotificationType.Success });
    } else if ('vibrate' in navigator) {
      navigator.vibrate([10, 50, 10]);
    }
  },

  async error() {
    if (CapacitorBridge.isNative()) {
      const { Haptics, NotificationType } = await import('@capacitor/haptics');
      await Haptics.notification({ type: NotificationType.Error });
    } else if ('vibrate' in navigator) {
      navigator.vibrate([30, 50, 30, 50, 30]);
    }
  }
};
```

#### Status Bar Adapter

```javascript
const StatusBarAdapter = {
  async setThemeColor(color) {
    if (CapacitorBridge.isNative()) {
      const { StatusBar, Style } = await import('@capacitor/status-bar');
      await StatusBar.setBackgroundColor({ color });
      await StatusBar.setStyle({ style: Style.Light });
    }
  },

  async show() {
    if (CapacitorBridge.isNative()) {
      const { StatusBar } = await import('@capacitor/status-bar');
      await StatusBar.show();
    }
  },

  async hide() {
    if (CapacitorBridge.isNative()) {
      const { StatusBar } = await import('@capacitor/status-bar');
      await StatusBar.hide();
    }
  }
};
```

#### Storage Adapter

```javascript
const StorageAdapter = {
  async get(key) {
    if (CapacitorBridge.isNative()) {
      const { Preferences } = await import('@capacitor/preferences');
      const { value } = await Preferences.get({ key });
      return value;
    } else {
      return localStorage.getItem(key);
    }
  },

  async set(key, value) {
    if (CapacitorBridge.isNative()) {
      const { Preferences } = await import('@capacitor/preferences');
      await Preferences.set({ key, value });
    } else {
      localStorage.setItem(key, value);
    }
  }
};
```

### 3. Service Worker Conditional Registration

**Location**: `index.html` script section
**Responsibility**: Only register SW in web context, skip in native

```javascript
if ('serviceWorker' in navigator && !window.Capacitor) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/silly-apps/sw.js')
      .then(registration => {
        console.log('ServiceWorker registered (web only)');
      })
      .catch(err => {
        console.log('ServiceWorker registration failed:', err);
      });
  });
} else {
  console.log('Service Worker skipped (native app)');
}
```

## Technology Stack

| Layer | Technology | Rationale |
|-------|------------|-----------|
| **Native Runtime** | Capacitor 6.x | Industry standard, maintained by Ionic, supports vanilla JS |
| **iOS Development** | Xcode 15+, Swift 5 | Required for iOS app development |
| **Android Development** | Android Studio, Gradle 8 | Required for Android app development |
| **Build System** | npm scripts | Simple, no complex build tool needed |
| **Package Management** | npm | Industry standard, lightweight |
| **Native Plugins** | @capacitor/haptics<br>@capacitor/status-bar<br>@capacitor/splash-screen<br>@capacitor/preferences | Official Capacitor plugins, well-maintained |
| **Icon Library** | Lucide (bundled) | Already in use, will bundle locally |
| **Web APIs** | HTML5 Canvas<br>Web Audio API<br>Vibration API (fallback) | Browser-native, no dependencies |
| **Code Quality** | ESLint (optional) | JavaScript linting |
| **Testing** | Manual + Xcode/Android Studio | Given simplicity, automated tests optional |

## Migration Phases

### Phase 1: Foundation (Week 1-2)
**Goal**: Set up Capacitor project structure

**Tasks**:
- Initialize npm project (`npm init`)
- Install Capacitor CLI and core
- Run `npx cap init` with app details
- Create `www/` directory and move web files
- Update paths in HTML/CSS/JS (remove `/silly-apps/` prefix)
- Add iOS platform (`npx cap add ios`)
- Add Android platform (`npx cap add android`)
- Test app launches in simulators/emulators

**Deliverable**: Both platforms build and display web content

### Phase 2: Asset Bundling (Week 2-3)
**Goal**: Make app fully offline-capable

**Tasks**:
- Download Lucide icons library, place in `www/assets/lucide/`
- Update icon references from CDN to local
- Generate iOS icon set (all sizes)
- Generate Android adaptive icons
- Configure splash screens
- Test all assets load offline

**Deliverable**: App works without internet connection

### Phase 3: Native API Integration (Week 3-4)
**Goal**: Replace web APIs with native equivalents

**Tasks**:
- Install Capacitor plugins
- Create `capacitor-bridge.js` and `platform-adapters.js`
- Refactor `haptics` object in app.js to use `HapticsAdapter`
- Configure status bar color
- Add splash screen logic
- Test haptics on physical devices

**Deliverable**: Native features working on iOS and Android

### Phase 4: Platform-Specific Configuration (Week 4-5)
**Goal**: Polish and optimize for each platform

**Tasks**:
- Configure iOS Info.plist (permissions, display name)
- Configure Android AndroidManifest.xml
- Set up iOS safe area insets
- Handle Android system bars
- Test on multiple device sizes
- Performance profiling

**Deliverable**: App looks native on both platforms

### Phase 5: Build & Submission (Week 5-6)
**Goal**: Prepare for app store submission

**Tasks**:
- iOS: Archive build, validate, upload to TestFlight
- Android: Generate signed AAB, upload to Play Console internal testing
- Create app store screenshots
- Write app descriptions
- Publish privacy policy
- Submit for review

**Deliverable**: Apps live in stores

## Build Pipeline

### Local Development Workflow

```bash
# 1. Make changes to www/ files (HTML/JS/CSS)

# 2. Sync changes to native projects
npx cap sync

# 3a. Run iOS (opens Xcode)
npx cap open ios
# Then press ⌘R in Xcode to run

# 3b. Run Android (opens Android Studio)
npx cap open android
# Then press Run (▶) in Android Studio

# 4. Live reload (optional)
npx cap run ios --livereload
npx cap run android --livereload
```

### Production Build Workflow

**iOS**:
```bash
# 1. Sync latest changes
npx cap sync ios

# 2. Open in Xcode
npx cap open ios

# 3. In Xcode:
#    - Select "Any iOS Device" as target
#    - Product > Archive
#    - Organizer > Distribute App > App Store Connect
```

**Android**:
```bash
# 1. Sync latest changes
npx cap sync android

# 2. Open in Android Studio
npx cap open android

# 3. In Android Studio:
#    - Build > Generate Signed Bundle/APK
#    - Select "Android App Bundle"
#    - Sign with keystore
#    - Upload AAB to Play Console
```

## Configuration

### capacitor.config.json

```json
{
  "appId": "com.fidgetfun.app",
  "appName": "Fidget Fun",
  "webDir": "www",
  "bundledWebRuntime": false,
  "server": {
    "cleartext": true
  },
  "ios": {
    "contentInset": "always"
  },
  "android": {
    "backgroundColor": "#667eea"
  },
  "plugins": {
    "SplashScreen": {
      "launchShowDuration": 2000,
      "backgroundColor": "#667eea",
      "showSpinner": false
    },
    "StatusBar": {
      "backgroundColor": "#667eea",
      "style": "LIGHT"
    }
  }
}
```

## Risk Mitigation

| Risk | Impact | Probability | Mitigation |
|------|--------|-------------|------------|
| Canvas performance in WebView | High | Medium | Early testing on low-end devices; reduce particle count if needed |
| Haptic API differences | Medium | Low | Abstraction layer handles platform differences |
| App size too large | Medium | Low | Bundle only essential assets; optimize images |
| App Store rejection | High | Medium | Follow guidelines; add compelling description |
| CDN dependency failure | High | Low | Bundle Lucide locally |
| Service Worker conflicts | Medium | Low | Conditional registration |
| Build environment complexity | Low | Medium | Document prerequisites; create setup scripts |

## Performance Optimizations

1. **Lazy Load Icons**: Only load icons for current screen
2. **Canvas Optimization**: Use `requestAnimationFrame` for animations
3. **Minimize Repaints**: Use CSS transforms for animations
4. **Image Compression**: Compress all PNG assets
5. **Service Worker**: Cache-first for static assets
6. **Memory Management**: Clean up particle DOM elements promptly
7. **Haptic Throttling**: 50ms throttle on sliders, 100ms on spinner
8. **Audio Context Pooling**: Reuse AudioContext instances

## Update Strategy

### Web PWA (GitHub Pages)
- Push to `main` branch → Auto-deploys in 1-3 minutes
- Service Worker updates automatically
- No app store approval needed

### Native Apps (iOS/Android)
- Sync www/ → `npx cap copy` → rebuild → resubmit
- Minor updates: 1-2 days approval (iOS), hours (Android)
- Major updates: 1-3 days (iOS), 1-7 days (Android)
- Emergency fixes: TestFlight/Internal Testing

---

**Document maintained by**: FORGE Architect Agent
**Last updated**: 2025-10-22
**Status**: Active Development
